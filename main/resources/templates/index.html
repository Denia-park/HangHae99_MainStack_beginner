
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/style.css">

    <title>ììœ ê²Œì‹œíŒ</title>
    <meta property="og:title" content="ììœ ê²Œì‹œíŒ" />
    <meta property="og:description" content="í•˜ê³ ì‹¶ì€ ë§ í•˜ì„¸ìš”" />
    <!--    <meta property="og:image" content="{{ url_for('static', filename='/img/mW_img.png') }}" />-->

    <script th:inline="javascript">
        $(document).ready(function () {
            // id ê°€ query ì¸ ë…€ì„ ìœ„ì—ì„œ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ execSearch() í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤.
            $('#close_write').on('click', function () {
                $('#container_write').removeClass('active');
            })

            getMessages();
            // showProduct();
        })

        const href = location.href;
        const queryString = href.substring(href.indexOf("?")+1)

        if (queryString === 'loginUserDoNotEnterErr') {
            alert("ì´ë¯¸ ë¡œê·¸ì¸ì´ ë˜ì–´ìˆìŠµë‹ˆë‹¤.");
            window.location.href = '/';
        }

        function getMessages() {
            // 1. ê¸°ì¡´ ë‚´ìš©ì„ ì§€ì›ë‹ˆë‹¤.
            // $('#cards-box').empty();
            // 2. ë©”ëª¨ ëª©ë¡ì„ ë¶ˆëŸ¬ì™€ì„œ HTMLë¡œ ë¶™ì…ë‹ˆë‹¤.
            $.ajax({
                type: 'GET',
                url: '/api/freetables',
                success: function (response) {
                    console.log(response);
                    //íƒ€ì„ë¦¬í”„ë¥¼ ì´ìš©í•´ì„œ ê²Œì‹œíŒì„ ê¾¸ë©°ì•¼ë¨ !!.
                    for (let i = 0; i < response.length; i++) {
                        let tableMsg = response[i];
                        let id = tableMsg['id'];
                        let title = tableMsg['title'];
                        let writer = tableMsg['username'];
                        let createdAt = convertUTCTimeToSeoulTime(tableMsg['createdAt']);
                        addTableHTML(id, title ,writer, createdAt);
                    }
                }
            })
        }

        function convertUTCTimeToSeoulTime(UTCDate){
            let SeoulTime = new Date(UTCDate)
            SeoulTime.setHours(SeoulTime.getHours()+9)
            // console.log(SeoulTime.toLocaleString())
            return SeoulTime.toLocaleString()
        }

        function addTableHTML(id,title ,username, createdAt) {
            // 1. HTML íƒœê·¸ë¥¼ ë§Œë“­ë‹ˆë‹¤.
            let tempHtml = `
                            <tr>
                                <th scope="row">${id}</th>
                                <td colspan="3" onclick="enter_board_view(${id})">
                                    <b style="cursor: pointer;">
                                        ${title}
                                    </b>
                                </td>
                                <td>${username}</td>
                                <td>${createdAt}</td>
                            </tr>
                    `;
            // 2. #cards-box ì— HTMLì„ ë¶™ì¸ë‹¤.
            $('#tableBody').append(tempHtml);
        }

        function enter_board_view(id) {
            $('#container_view_warp').empty();
            $.ajax({
                type: 'GET',
                url: `/api/freetables/${id}`,
                success: function (response) {
                    let tableMsg = response;
                    let title = tableMsg['title'];
                    let writer = tableMsg['username'];
                    let content = tableMsg['content'];
                    let createdAt = convertUTCTimeToSeoulTime(tableMsg['createdAt']);
                    addTableViewHTML(title, writer, content,createdAt);

                    $('#container_view').addClass('active');

                    $('#close_view').on('click', function () {
                        $('#container_view').removeClass('active');
                    })
                }
            })
        }

        function addTableViewHTML(title, writer, content ,createdAt) {
            // 1. HTML íƒœê·¸ë¥¼ ë§Œë“­ë‹ˆë‹¤.
            let tempHtml = `
                            <div id="container_view" class="popup-container_view">
                                <div class="popup_view">
                                    <button id="close_view" class="close_view">
                                            X
                                    </button>
                                    <h1>
                                        <b>
                                            ğŸ“œê²Œì‹œê¸€ ì¡°íšŒ í˜ì´ì§€
                                        </b>
                                    </h1>
                                    <div>
                                        <b style="font-size: 13pt">ì‘ì„±ì¼</b>
                                        <p>${createdAt}</p>
                                    </div>
                                    <div>
                                        <b style="font-size: 17pt">ê¸€ ì œëª©</b>
                                        <p>${title}</p>
                                    </div>
                                    <div>
                                        <b style="font-size: 17pt">ì‘ì„±ì</b>
                                        <p>${writer}</p>
                                    </div>
                                    <div>
                                        <b style="font-size: 17pt">ë‚´ìš©</b>
                                        <p>${content}</p>
                                    </div>
                                </div>
                            </div>
                    `;
            // 2. #container_view_warp ì— HTMLì„ ë¶™ì¸ë‹¤.
            $('#container_view_warp').append(tempHtml);
        }

    </script>

    <script th:if="${userLoginCheck}" th:inline="javascript">

    function enter_board_write(){
            if([[${userLoginCheck}]])
                $('#container_write').addClass('active');
            else
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }

        function postWriting() {
            let ftTitle = $('#mytitle').val();
            let ftUsername = [[${username}]];
            let ftContents = $('#mycontent').val();

            if (isValidContents(ftTitle) == false) {
                return;
            }
            if (isValidContents(ftContents) == false) {
                return;
            }

            let data = {'title': ftTitle, 'username': ftUsername ,'content': ftContents};

            $.ajax({ // $.ajax = jQeury ë¥¼ ì´ìš©í•˜ê² ë‹¤.
                type: "POST",
                url: "/api/freetables",
                contentType: "application/json", // JSON í˜•ì‹ìœ¼ë¡œ ì „ë‹¬í•¨ì„ ì•Œë¦¬ê¸°
                data: JSON.stringify(data), //ì›¹ì—ì„œ ì£¼ê³  ë°›ì„ ë•Œ ìŠ¤íŠ¸ë§ìœ¼ë¡œë§Œ ì£¼ê³  ë°›ê¸° ë•Œë¬¸ì— ë¬¸ìì—´ë¡œ ë°”ê¿”ì„œ ì „ë‹¬í•¨
                success: function (response) {
                    if(response == null){
                        alert("ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”");
                        window.location.reload();
                    }
                    alert('ë©”ì‹œì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.reload();
                }
            });
        }

        function isValidContents(contents) {
            if (contents == '') {
                alert('ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return false;
            }
            if (contents.trim().length > 30) {
                alert('ê³µë°± í¬í•¨ 30ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return false;
            }
            return true;
        }

    </script>

</head>

<body style="background-color:black">
<div class="indexOf">


    <div class="title_h1">
        <h1> <b>ììœ ê²Œì‹œíŒ</b> </h1>
    </div>

    <div th:if="${userLoginCheck}" style="color: white; font-size: 20pt; text-align:right;">
        <span th:text="${username}"></span> ë‹˜ ì•ˆë…•í•˜ì„¸ìš”.
    </div>

    <div class="button_wrapper">

        <div th:if="${userLoginCheck}" class="login_button">
            <button type="button"  onclick="location.href='/user/logout'" class="btn btn-secondary">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div th:unless="${userLoginCheck}" class="write_button">
            <button type="button"  onclick="location.href='/user/signup'" class="btn btn-secondary">íšŒì›ê°€ì…</button>
            <button type="button"  onclick="location.href='/user/login'" class="btn btn-secondary" style="margin-left: 15px;">ë¡œê·¸ì¸</button>
        </div>

        <div th:if="${userLoginCheck}" class="write_button">
            <button type="button"  onclick="enter_board_write()" class="btn btn-secondary">ê¸€ ì“°ê¸°</button>
        </div>
    </div>


    <table class="table table-dark table-hover">
        <thead class="tablehead">
        <tr style="color: indianred">
            <th scope="col">ë²ˆí˜¸</th>
            <th scope="col" colspan="3">ê¸€ ì œëª©</th>
            <th scope="col">ì‘ì„±ì</th>
            <th scope="col">ì‘ì„±ì¼</th>
        </tr>
        </thead>
        <tbody id="tableBody">

        </tbody>
    </table>

    <div th:if="${userLoginCheck != null}" id="container_write" class="popup-container_write">
        <div class="popup_write">
            <button id="close_write" class="close_write">
                X
            </button>
            <h1>
                <b>
                    âœê¸€ ì“°ê¸° í˜ì´ì§€
                </b>
            </h1>
            <p>í•˜ê³  ì‹¶ì€ ë§ì„ ì§§ê²Œ ì¨ì£¼ì„¸ìš”.</p>
            <div>
                <p>
                    <b>ê¸€ ì œëª©</b>
                </p>
                <input type="text" id="mytitle" placeholder="">
            </div>
            <div>
                <p>
                    <b>ë‚´ìš©</b>
                </p>
                <input type="text" id="mycontent" placeholder="">
            </div>
            <p>
            </p>
            <button class="cta_write" onclick="postWriting()">ê¸€ ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="container_view_warp">


    </div>
</div>

</body>
</html>


